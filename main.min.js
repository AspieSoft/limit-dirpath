const Module=require("module"),setPath=require("path"),fse=function(e){try{return require("fs-extra")}catch(e){return}}();class DeniedError extends Error{constructor(e){super(e),this.name="PermissionDenied",this.status=403}statusCode(){return this.status}}class UndefinedError extends Error{constructor(e){super(e),this.name="Undefined",this.status=403}statusCode(){return this.status}}module.exports=function({throwErrors:e=!0,root:n=!1,require:i="modules",modules:s=!0,fs:d=!1,eval:t=!1}){let r=["fs","fs-extra"];"object"==typeof s&&(s.deny&&(Array.isArray(s.deny)||(s.deny=[s.deny]),r=r.concat(s.deny)),s.allow&&(Array.isArray(s.allow)||(s.allow=[s.allow]),s=s.allow));const o={throwErrors:e,root:n,require:i,modules:s,denyModules:r,fs:d,eval:t};o.root?o.root=setPath.resolve(o.root):process.mainModule&&process.mainModule.filename&&(o.root=setPath.join(process.mainModule.filename,".."));const f={require:Module.prototype.require};function l(e,n){if(!1===o.throwErrors){if("undefined"===e)return;return null}switch(e){case"denied":throw new DeniedError(n);case"undefined":throw new UndefinedError(n);default:throw new Error(n)}}function u(e,n,i=!1,s=!1){if(o.root){if(!e){if(s)return;return l("undefined","filePath is not defined!")}let d=setPath.resolve(o.root);if(n&&(n=setPath.join(n,"..")),n&&""!==n.trim()||(n=d),e.startsWith(".")||!e.startsWith("/")&&!i){let i=d.indexOf("/");-1===i&&(i=d.indexOf("\\")),e=e.startsWith(d.substring(0,i))?setPath.resolve(e):setPath.join(n,e)}else if(e.startsWith("/"))e=setPath.join(d,e);else{if(!e.startsWith("/")&&i){let n=!0;if(o.modules){let i=o.modules;!1===i?n=!1:Array.isArray(i)&&(n=i.includes(e))}else if(!1===o.modules)return s?null:l("denied","Modules are not allowed!");return n&&r.length&&r.includes(e)&&(n=!1),n?{path:e,isModule:!0}:s?null:l("denied","That module is not allowed! module: "+e)}e=setPath.resolve(e)}if(!e.startsWith(d))return s?null:l("denied","Root access is limited to "+o.root);let t=e.replace(d,"");if(!t.includes("/")&&!t.includes("\\"))return s?null:l("denied","Root access is limited to "+o.root)}return{path:e,isModule:!1}}Module.prototype.require=function(e){if(!1===o.require)return l("denied","The require function is not allowed!");let n=u(e,this.filename,!0);return"modules"!==o.require||n.isModule?n?f.require.apply(this,[e]):l("undefined","filePath is not defined!"):l("denied","The require function is limited to modules!")},!0!==t&&"global"!==(t=function(){return l("denied","Cannot use eval!")})&&(global.eval=t);const a={};if(o.fs){let e=o.fs;!0===o.fs?e=["read","write","stream","add","modify","append","delete","rename","watch","copy","move","exists","sync","dir","js","json"]:Array.isArray(e)||(e=[]),a.fs={},e.includes("read")&&(a.fs.readFile=function(n,i,s){let d=u(n,this.filename);return d?(d=d.path,!e.includes("js")&&d.endsWith(".js")?l("denied","Cannot read js files!"):!e.includes("json")&&d.endsWith(".json")?l("denied","Cannot read json files!"):fse.readFile(d,i,s)):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.readFileSync=function(n,i){let s=u(n,this.filename);return s?(s=s.path,!e.includes("js")&&s.endsWith(".js")?l("denied","Cannot read js files!"):!e.includes("json")&&s.endsWith(".json")?l("denied","Cannot read json files!"):fse.readFileSync(s,i)):l("undefined","filePath is not defined!")}),e.includes("dir")&&(a.fs.readdir=function(n,i){let s=u(n,this.filename);return s?(s=s.path,!e.includes("js")&&s.endsWith(".js")?l("denied","Cannot read js files!"):!e.includes("json")&&s.endsWith(".json")?l("denied","Cannot read json files!"):fse.readdir(s,i)):l("undefined","filePath is not defined!")},a.fs.readdirSync=function(n){let i=u(n,this.filename);return i?(i=i.path,!e.includes("js")&&i.endsWith(".js")?l("denied","Cannot read js files!"):!e.includes("json")&&i.endsWith(".json")?l("denied","Cannot read json files!"):fse.readdirSync(i)):l("undefined","filePath is not defined!")}),e.includes("json")&&(a.fs.readJson=function(e,n){let i=u(e,this.filename);return i?(i=i.path,fse.readJson(i,n)):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.readJsonSync=function(e){let n=u(e,this.filename);return n?(n=n.path,fse.readJsonSync(n)):l("undefined","filePath is not defined!")})),e.includes("stream")&&(a.fs.createReadStream=function(n,i){let s=u(n,this.filename);return s?(s=s.path,!e.includes("js")&&s.endsWith(".js")?l("denied","Cannot read js files!"):!e.includes("json")&&s.endsWith(".json")?l("denied","Cannot read json files!"):fse.createReadStream(s,i)):l("undefined","filePath is not defined!")})),e.includes("write")&&(a.fs.writeFile=function(n,i,s){let d=u(n,this.filename);if(!d)return l("undefined","filePath is not defined!");if(d=d.path,!e.includes("js")&&d.endsWith(".js"))return l("denied","Cannot modify js files!");if(!e.includes("json")&&d.endsWith(".json"))return l("denied","Cannot modify json files!");if(!e.includes("add")&&!e.includes("modify"))return fse.writeFile(d,i,s);{let n=fse.existsSync(d);if(n&&!e.includes("modify"))return l("denied","Cannot modify existing files!");if(!n&&!e.includes("add"))return l("denied","Cannot add new files!")}return e.includes("dir")&&fse.ensureDirSync(setPath.join(d,"..")),fse.writeFile(d,i,s)},e.includes("sync")&&(a.fs.writeFileSync=function(n,i){let s=u(n,this.filename);if(!s)return l("undefined","filePath is not defined!");if(s=s.path,!e.includes("js")&&s.endsWith(".js"))return l("denied","Cannot modify js files!");if(!e.includes("json")&&s.endsWith(".json"))return l("denied","Cannot modify json files!");if(!e.includes("add")&&!e.includes("modify"))return fse.writeFileSync(s,i);{let n=fse.existsSync(s);if(n&&!e.includes("modify"))return l("denied","Cannot modify existing files!");if(!n&&!e.includes("add"))return l("denied","Cannot add new files!")}return e.includes("dir")&&fse.ensureDirSync(setPath.join(s,"..")),fse.writeFileSync(s,i)}),!e.includes("dir")||!e.includes("add")&&e.includes("modify")||(a.fs.mkdir=function(e,n){let i=u(e,this.filename);return i?(i=i.path,fse.ensureDirSync(setPath.join(i,"..")),fse.mkdir(i,n)):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.mkdirSync=function(e){let n=u(e,this.filename);return n?(n=n.path,fse.ensureDirSync(setPath.join(n,"..")),fse.mkdirSync(n)):l("undefined","filePath is not defined!")})),e.includes("json")&&(a.fs.writeJson=function(n,i,s){let d=u(n,this.filename);return d?(e.includes("dir")&&fse.ensureDirSync(setPath.join(d,"..")),fse.writeJson(d,i,s)):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.writeJsonSync=function(n,i){let s=u(n,this.filename);return s?(s=s.path,e.includes("dir")&&fse.ensureDirSync(setPath.join(s,"..")),fse.writeJsonSync(s,i)):l("undefined","filePath is not defined!")})),e.includes("stream")&&(a.fs.createWriteStream=function(n,i){let s=u(n,this.filename);return s?(s=s.path,!e.includes("js")&&s.endsWith(".js")?l("denied","Cannot read js files!"):!e.includes("json")&&s.endsWith(".json")?l("denied","Cannot read json files!"):fse.createWriteStream(s,i)):l("undefined","filePath is not defined!")})),e.includes("delete")&&(a.fs.remove=function(n,i){let s=u(n,this.filename);return s?(s=s.path,e.includes("dir")||s.match(/\.[A-Za-z0-9]$/)?fse.remove(s,i):l("denied","Cannot remove directories!")):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.removeSync=function(n){let i=u(n,this.filename);return i?(i=i.path,e.includes("dir")||i.match(/\.[A-Za-z0-9]$/)?fse.removeSync(i):l("denied","Cannot remove directories!")):l("undefined","filePath is not defined!")}),e.includes("dir")&&(a.fs.emptyDir=function(e,n){let i=u(e,this.filename);return i?(i=i.path,fse.emptyDir(i,n)):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.emptyDirSync=function(e){let n=u(e,this.filename);return n?(n=n.path,fse.emptyDirSync(n)):l("undefined","filePath is not defined!")}))),e.includes("append")&&(a.fs.appendFile=function(n,i,s){let d=u(n,this.filename);return d?(d=d.path,!e.includes("js")&&d.endsWith(".js")?l("denied","Cannot modify js files!"):!e.includes("json")&&d.endsWith(".json")?l("denied","Cannot modify json files!"):e.includes("dir")||fse.existsSync(setPath.join(d,".."))?((e.includes("add")||!e.includes("modify")&&e.includes("write"))&&fse.ensureFileSync(d),fse.appendFile(d,i,s)):l("undefined","Directory does not exist!")):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.appendFileSync=function(n,i){let s=u(n,this.filename);return s?(s=s.path,!e.includes("js")&&s.endsWith(".js")?l("denied","Cannot modify js files!"):!e.includes("json")&&s.endsWith(".json")?l("denied","Cannot modify json files!"):e.includes("dir")||fse.existsSync(setPath.join(s,".."))?((e.includes("add")||!e.includes("modify")&&e.includes("write"))&&fse.ensureFileSync(s),fse.appendFileSync(s,i)):l("undefined","Directory does not exist!")):l("undefined","filePath is not defined!")})),e.includes("copy")&&(a.fs.copy=function(n,i,s,d=!1){if(!(n=u(n,this.filename)))return l("undefined","src is not defined!");if(n=n.path,!(i=u(i,this.filename)))return l("undefined","dest is not defined!");if(i=i.path,!e.includes("js")&&(n.endsWith(".js")||i.endsWith(".js")))return l("denied","Cannot modify js files!");if(!e.includes("json")&&(n.endsWith(".json")||i.endsWith(".json")))return l("denied","Cannot modify json files!");let t={dereference:!0,preserveTimestamps:!0};return t.overwrite=e.includes("add")||!e.includes("modify")&&e.includes("write"),d||(t.overwrite=!1),t.errorOnExist=o.throwErrors,fse.copy(n,i,t,s)},e.includes("sync")&&(a.fs.copySync=function(n,i,s=!1){if(!(n=u(n,this.filename)))return l("undefined","src is not defined!");if(n=n.path,!(i=u(i,this.filename)))return l("undefined","dest is not defined!");if(i=i.path,!e.includes("js")&&(n.endsWith(".js")||i.endsWith(".js")))return l("denied","Cannot modify js files!");if(!e.includes("json")&&(n.endsWith(".json")||i.endsWith(".json")))return l("denied","Cannot modify json files!");let d={dereference:!0,preserveTimestamps:!0};return d.overwrite=e.includes("add")||!e.includes("modify")&&e.includes("write"),s||(d.overwrite=!1),d.errorOnExist=o.throwErrors,fse.copySync(n,i,d)})),e.includes("move")&&(a.fs.move=function(n,i,s,d=!1){if(!(n=u(n,this.filename)))return l("undefined","src is not defined!");if(n=n.path,!(i=u(i,this.filename)))return l("undefined","dest is not defined!");if(i=i.path,!e.includes("js")&&(n.endsWith(".js")||i.endsWith(".js")))return l("denied","Cannot modify js files!");if(!e.includes("json")&&(n.endsWith(".json")||i.endsWith(".json")))return l("denied","Cannot modify json files!");let t={dereference:!0,preserveTimestamps:!0};return t.overwrite=e.includes("add")||!e.includes("modify")&&e.includes("write"),d||(t.overwrite=!1),t.errorOnExist=o.throwErrors,fse.move(n,i,t,s)},e.includes("sync")&&(a.fs.moveSync=function(n,i,s=!1){if(!(n=u(n,this.filename)))return l("undefined","src is not defined!");if(n=n.path,!(i=u(i,this.filename)))return l("undefined","dest is not defined!");if(i=i.path,!e.includes("js")&&(n.endsWith(".js")||i.endsWith(".js")))return l("denied","Cannot modify js files!");if(!e.includes("json")&&(n.endsWith(".json")||i.endsWith(".json")))return l("denied","Cannot modify json files!");let d={dereference:!0,preserveTimestamps:!0};return d.overwrite=e.includes("add")||!e.includes("modify")&&e.includes("write"),s||(d.overwrite=!1),d.errorOnExist=o.throwErrors,fse.moveSync(n,i,d)})),e.includes("watch")&&(a.fs.watch=function(n,i,s){let d=u(n,this.filename);return d?(d=d.path,!e.includes("js")&&d.endsWith(".js")?l("denied","Cannot modify js files!"):!e.includes("json")&&d.endsWith(".json")?l("denied","Cannot modify json files!"):e.includes("dir")||fse.existsSync(setPath.join(d,".."))?fse.watch(d,i,s):l("undefined","Directory does not exist!")):l("undefined","filePath is not defined!")}),e.includes("rename")&&(a.fs.rename=function(n,i,s){return(n=u(n,this.filename))&&(i=u(n=n.path,this.filename))?(i=i.path,e.includes("js")||!n.endsWith(".js")&&!i.endsWith(".js")?e.includes("json")||!n.endsWith(".json")&&!i.endsWith(".json")?e.includes("dir")||n.match(/\.[A-Za-z0-9]$/)&&i.match(/\.[A-Za-z0-9]$/)?fse.rename(n,i,s):l("denied","Cannot remove directories!"):l("denied","Cannot modify json files!"):l("denied","Cannot modify js files!")):l("undefined","filePath is not defined!")},e.includes("sync")&&(a.fs.renameSync=function(n,i,s){return(n=u(n,this.filename))&&(i=u(n=n.path,this.filename))?(i=i.path,e.includes("js")||!n.endsWith(".js")&&!i.endsWith(".js")?e.includes("json")||!n.endsWith(".json")&&!i.endsWith(".json")?e.includes("dir")||n.match(/\.[A-Za-z0-9]$/)&&i.match(/\.[A-Za-z0-9]$/)?fse.renameSync(n,i,s):l("denied","Cannot remove directories!"):l("denied","Cannot modify json files!"):l("denied","Cannot modify js files!")):l("undefined","filePath is not defined!")})),e.includes("exists")&&(a.fs.existsSync=function(n){let i=u(n,this.filename,!1,!0);return null===i?null:void 0!==i?!!i&&(i=i.path,!e.includes("js")&&i.endsWith(".js")?l("denied","Cannot modify js files!"):!e.includes("json")&&i.endsWith(".json")?l("denied","Cannot modify json files!"):e.includes("dir")||i.match(/\.[A-Za-z0-9]$/)?fse.existsSync(i):l("denied","Cannot remove directories!")):void 0},a.fs.existsModuleSync=function(n){let i=u(n,this.filename,!0,!0);return null===i?null:void 0!==i?!!i&&!!i.isModule&&(i=i.path,!e.includes("js")&&i.endsWith(".js")||!e.includes("json")&&i.endsWith(".json")?null:e.includes("dir")||i.match(/\.[A-Za-z0-9]$/)?fse.existsSync(i):null):void 0})}return a};